---
import '@fontsource-variable/inter';
import '../styles/reset.css';
import '../styles/global.css';
import { sift } from 'radash';
import Footer from '../components/layout/Footer.astro';
import countriesList from '../data/mapping/countries.ts';
import missionData from '../data/mission/mission.json';
import { validateMission } from '../validators/mission';
import 'remixicon/fonts/remixicon.css';

export interface Properties {
  title?: string;
  description?: string;
  canonicalUrl?: string;
  countrySlug?: string;
  articleSchema?: Record<string, unknown>;
  noIndex?: boolean;
  image?: string;
}

const {
  title = 'Timothy for Change',
  description,
  canonicalUrl,
  countrySlug,
  articleSchema,
  noIndex,
  image,
} = Astro.props as Properties;

const mission = validateMission(missionData);

const countryNames = Array.isArray(countriesList)
  ? sift(countriesList.map((c) => c.name)).join(', ')
  : '';
const defaultDescription = `Timothy for Change - ${mission.mission}. Learn about ongoing conflicts and structural violence in ${countryNames}.`;

function trimDescription(desc: string, max = 160) {
  if (!desc) {
    return '';
  }

  const cleaned = desc.replaceAll(/\s+/g, ' ').trim();

  return cleaned.length > max
    ? `${cleaned.slice(0, max - 1).trimEnd()}â€¦`
    : cleaned;
}

const rawDescription = description || defaultDescription;
const pageDescription = trimDescription(rawDescription, 160);
const pageCanonicalUrl = canonicalUrl || 'https://timothyforchange.co.za/';
const pageImage = image || 'https://timothyforchange.co.za/united-nations.webp';

const baseLdObject = {
  '@context': 'https://schema.org',
  '@graph': [
    {
      '@type': 'Person',
      '@id': 'https://timothyforchange.co.za/#person',
      name: 'Timothy Brits',
      alternateName: 'Timothy',
      url: 'https://timothyforchange.co.za',
      jobTitle: 'Analyst of Structural Violence',
      address: {
        '@type': 'PostalAddress',
        addressLocality: 'Pretoria',
        addressCountry: 'ZA',
      },
      knowsAbout: ['Structural Violence Analysis', 'Global Crises'],
      sameAs: [
        'https://github.com/TimothyForChange',
        'https://instagram.com/timothyforchange/',
        'https://threads.com/@timothyforchange',
      ],
    },
    {
      '@type': 'WebSite',
      '@id': 'https://timothyforchange.co.za/#website',
      url: 'https://timothyforchange.co.za',
      name: 'Timothy for Change',
      description: `Timothy for Change - ${mission.mission}`,
      publisher: {
        '@id': 'https://timothyforchange.co.za/#person',
      },
      potentialAction: {
        '@type': 'SearchAction',
        target: {
          '@type': 'EntryPoint',
          urlTemplate:
            'https://timothyforchange.co.za/?search={search_term_string}',
        },
        'query-input': 'required name=search_term_string',
      },
    },
    {
      '@type': 'BreadcrumbList',
      '@id': 'https://timothyforchange.co.za/#breadcrumb',
      itemListElement: [
        {
          '@type': 'ListItem',
          position: 1,
          name: 'Home',
          item: 'https://timothyforchange.co.za',
        },
        ...(countrySlug
          ? [
              {
                '@type': 'ListItem',
                position: 2,
                name: Array.isArray(countriesList)
                  ? countriesList.find((c) => c.slug === countrySlug)?.name ||
                    countrySlug
                  : countrySlug,
                item: `https://timothyforchange.co.za/${countrySlug}`,
              },
            ]
          : []),
      ],
    },
    {
      '@type': 'WebPage',
      '@id': `${pageCanonicalUrl}#webpage`,
      url: pageCanonicalUrl,
      name: title,
      description: pageDescription,
      inLanguage: 'en-ZA',
      isPartOf: {
        '@id': 'https://timothyforchange.co.za/#website',
      },
      primaryImageOfPage: pageImage
        ? {
            '@type': 'ImageObject',
            url: pageImage,
          }
        : undefined,
      breadcrumb: {
        '@id': 'https://timothyforchange.co.za/#breadcrumb',
      },
    },
  ],
};

const ldObject = {
  '@context': 'https://schema.org',
  '@graph': [
    ...baseLdObject['@graph'],
    ...(articleSchema ? [articleSchema] : []),
  ],
};
const ldJson = JSON.stringify(ldObject, undefined, 2);
---

<!doctype html>
<html lang='en'>
  <head>
    <meta charset='utf8' />
    <meta name='description' content={pageDescription} />
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <meta name='author' content='Timothy for Change' />
    <meta
      name='robots'
      content={noIndex ? 'noindex, follow' : 'index, follow'}
    />
    <meta property='og:type' content='website' />
    <meta property='og:url' content={pageCanonicalUrl} />
    <meta property='og:title' content={title} />
    <meta property='og:description' content={pageDescription} />
    <meta property='og:image' content={pageImage} />
    <meta property='og:site_name' content='Timothy for Change' />
    <meta name='twitter:card' content='summary_large_image' />
    <meta name='twitter:title' content={title} />
    <meta name='twitter:description' content={pageDescription} />
    <meta name='twitter:image' content={pageImage} />
    <meta name='color-scheme' content='light dark' />
    <link rel='canonical' href={pageCanonicalUrl} />
    <link rel='apple-touch-icon' sizes='180x180' href='/apple-touch-icon.png' />
    <link rel='icon' type='image/png' sizes='32x32' href='/favicon-32x32.png' />
    <link rel='icon' type='image/png' sizes='16x16' href='/favicon-16x16.png' />
    <link rel='manifest' href='/site.webmanifest' />
    <title>{title}</title>
    <link rel='sitemap' href='/sitemap-index.xml' />
    <script type='application/ld+json' set:html={ldJson} />
  </head>
  <body>
    <a class='skip-link' href='#container'>Skip to main content</a>
    <slot />
    <Footer />
    <script is:inline>
      document.addEventListener('DOMContentLoaded', () => {
        const skipLink = document.querySelector('.skip-link');

        if (skipLink) {
          skipLink.addEventListener('click', (event_) => {
            event_.preventDefault();
            const target = document.querySelector('#container');

            if (target) {
              target.focus();
              target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          });
        }

        const isTouchDevice =
          'ontouchstart' in window || navigator.maxTouchPoints > 0;

        if (isTouchDevice) {
          const tooltipSpans = document.querySelectorAll('span[data-tooltip]');

          const hideAllTooltips = () => {
            tooltipSpans.forEach((span) =>
              span.classList.remove('show-tooltip')
            );
          };

          tooltipSpans.forEach((span) => {
            span.addEventListener('touchstart', (event) => {
              event.preventDefault();
              hideAllTooltips();
              span.classList.toggle('show-tooltip');
            });
          });

          document.addEventListener('touchstart', (event) => {
            if (!event.target.closest('span[data-tooltip]')) {
              hideAllTooltips();
            }
          });
        }
      });
    </script>
  </body>
</html>
