---
import '@fontsource-variable/inter';
import '../styles/reset.css';
import '../styles/global.css';
import Footer from '../components/layout/Footer.astro';
import { SITE_URL } from '../constants/site';
import countriesList from '../data/mapping/countries.ts';
import missionData from '../data/mission/mission.json';
import { buildStructuredData } from '../utils/structured-data';
import { trimDescription } from '../utils/text';
import { validateMission } from '../validators/mission';
import 'remixicon/fonts/remixicon.css';

export interface Properties {
  title?: string;
  description?: string;
  canonicalUrl?: string;
  countrySlug?: string;
  articleSchema?: Record<string, unknown>;
  noIndex?: boolean;
  image?: string;
}

const {
  title = 'Timothy for Change',
  description,
  canonicalUrl,
  countrySlug,
  articleSchema,
  noIndex,
  image,
} = Astro.props as Properties;

const mission = validateMission(missionData);

const countryMapping = Array.isArray(countriesList)
  ? countriesList.find((c) => c.slug === countrySlug)
  : undefined;

const defaultDescription = `${mission.mission}. Learn about ongoing conflicts and structural violence in Palestine, Ukraine, Sudan, the DRC, the Sahel, and more.`;

const rawDescription = description || defaultDescription;
const pageDescription = trimDescription(rawDescription, 160);
const pageCanonicalUrl = canonicalUrl || `${SITE_URL}/`;
const pageImage = image || `${SITE_URL}/protest.jpg`;

const ldObject = buildStructuredData({
  title,
  pageDescription,
  pageCanonicalUrl,
  pageImage,
  countrySlug,
  articleSchema,
});
const ldJson = JSON.stringify(ldObject, undefined, 2);
---

<!doctype html>
<html lang='en'>
  <head>
    <meta charset='utf8' />
    <meta name='description' content={pageDescription} />
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <meta name='author' content='Timothy for Change' />
    <meta
      name='robots'
      content={noIndex ? 'noindex, follow' : 'index, follow'}
    />
    <meta property='og:type' content={articleSchema ? 'article' : 'website'} />
    <meta property='og:locale' content='en_GB' />
    <meta property='og:url' content={pageCanonicalUrl} />
    <meta property='og:title' content={title} />
    <meta property='og:description' content={pageDescription} />
    <meta property='og:image' content={pageImage} />
    <meta property='og:image:alt' content={title} />
    <meta property='og:site_name' content='Timothy for Change' />
    {
      articleSchema && (
        <>
          <meta property='article:author' content={`${SITE_URL}/#person`} />
          <meta
            property='article:published_time'
            content={String(articleSchema.datePublished)}
          />
          <meta
            property='article:modified_time'
            content={String(articleSchema.dateModified)}
          />
          {countryMapping?.category && (
            <meta
              property='article:section'
              content={countryMapping.category}
            />
          )}
          {Array.isArray(articleSchema.keywords) &&
            articleSchema.keywords.map((keyword) => (
              <meta property='article:tag' content={keyword} />
            ))}
        </>
      )
    }
    <meta name='twitter:card' content='summary_large_image' />
    <meta name='twitter:title' content={title} />
    <meta name='twitter:description' content={pageDescription} />
    <meta name='twitter:image' content={pageImage} />
    <meta name='twitter:image:alt' content={title} />
    <meta name='color-scheme' content='light dark' />
    <meta name='theme-color' content='#000000' />
    <link rel='canonical' href={pageCanonicalUrl} />
    <link rel='apple-touch-icon' sizes='180x180' href='/apple-touch-icon.png' />
    <link rel='icon' type='image/png' sizes='32x32' href='/favicon-32x32.png' />
    <link rel='icon' type='image/png' sizes='16x16' href='/favicon-16x16.png' />
    <link rel='manifest' href='/site.webmanifest' />
    <title>{title}</title>
    <link rel='sitemap' href='/sitemap-index.xml' />
    <script type='application/ld+json' set:html={ldJson} />
  </head>
  <body>
    <a class='skip-link' href='#container'>Skip to main content</a>
    <slot />
    <Footer />
    <script is:inline>
      document.addEventListener('DOMContentLoaded', () => {
        const skipLink = document.querySelector('.skip-link');
        if (skipLink) {
          skipLink.addEventListener('click', (event_) => {
            event_.preventDefault();
            const target = document.querySelector('#container');
            if (target) {
              target.focus();
              target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          });
        }
      });
    </script>
  </body>
</html>
